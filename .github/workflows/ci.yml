name: Build and Run API

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Start API and verify it responds
        run: |
          dotnet run --configuration Release --no-build --urls "http://localhost:5000" &
          API_PID=$!

          echo "Waiting for API to start..."
          for i in $(seq 1 30); do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/swagger/v1/swagger.json | grep -q "200"; then
              echo "API is up and responding!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "API failed to start within 30 seconds"
              kill $API_PID 2>/dev/null
              exit 1
            fi
            sleep 1
          done

          echo "Testing GET /api/accounts..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/accounts)
          if [ "$STATUS" != "200" ]; then
            echo "FAIL: /api/accounts returned $STATUS"
            kill $API_PID 2>/dev/null
            exit 1
          fi
          echo "PASS: /api/accounts returned 200"

          echo "Testing GET /api/registrations..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/registrations)
          if [ "$STATUS" != "200" ]; then
            echo "FAIL: /api/registrations returned $STATUS"
            kill $API_PID 2>/dev/null
            exit 1
          fi
          echo "PASS: /api/registrations returned 200"

          kill $API_PID 2>/dev/null
          echo "All checks passed!"
